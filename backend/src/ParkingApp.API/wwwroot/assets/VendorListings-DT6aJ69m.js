import{r as n,j as e,e as G,c as b,h as T,A as W,L as Y}from"./index-BD1vJQCf.js";import{s as i}from"./toast-BWJptWch.js";import{S as K,I as Z}from"./indianStatesCities-CpLRmfdt.js";import{M as J,T as Q,b as X,d as ee,u as te,L as E}from"./leaflet-BHpfzUxG.js";delete E.Icon.Default.prototype._getIconUrl;E.Icon.Default.mergeOptions({iconRetinaUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon-2x.png",iconUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-icon.png",shadowUrl:"https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png"});function se({onLocationSelect:m}){return ee({click(p){m(p.latlng.lat,p.latlng.lng)}}),null}function ae({lat:m,lng:p}){const x=te();return n.useEffect(()=>{m&&p&&x.setView([m,p],15)},[m,p,x]),null}function re({latitude:m,longitude:p,onLocationSelect:x}){const[c,N]=n.useState(null),[w,u]=n.useState(!1),y=parseFloat(m),f=parseFloat(p),C=!isNaN(y)&&!isNaN(f)&&y!==0&&f!==0;n.useEffect(()=>{C&&N([y,f])},[]);const F=n.useCallback((j,g)=>{N([j,g]),x(j.toFixed(6),g.toFixed(6))},[x]),S=()=>{if(!navigator.geolocation){alert("Geolocation is not supported by your browser");return}u(!0),navigator.geolocation.getCurrentPosition(j=>{const{latitude:g,longitude:a}=j.coords;N([g,a]),x(g.toFixed(6),a.toFixed(6)),u(!1)},j=>{alert("Unable to get your location. Please click on the map instead."),u(!1)},{enableHighAccuracy:!0,timeout:1e4})},P=C?[y,f]:[20.5937,78.9629],I=C?15:5;return e.jsxs("div",{className:"location-picker",children:[e.jsxs("div",{className:"location-picker-header",children:[e.jsx("label",{className:"form-label",style:{marginBottom:0},children:"üìç Select Location on Map"}),e.jsx("button",{type:"button",className:"btn btn-secondary btn-sm",onClick:S,disabled:w,style:{fontSize:"0.8rem",padding:"0.3rem 0.75rem"},children:w?"‚è≥ Locating...":"üìç Use My Location"})]}),e.jsx("div",{className:"map-container",style:{height:"300px",borderRadius:"var(--radius-md)",overflow:"hidden",marginTop:"0.5rem"},children:e.jsxs(J,{center:P,zoom:I,style:{height:"100%",width:"100%"},scrollWheelZoom:!0,children:[e.jsx(Q,{attribution:'¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"}),e.jsx(se,{onLocationSelect:F}),c&&e.jsxs(e.Fragment,{children:[e.jsx(X,{position:c}),e.jsx(ae,{lat:c[0],lng:c[1]})]})]})}),c&&e.jsxs("div",{className:"location-coords",children:[e.jsxs("span",{children:["Lat: ",e.jsx("strong",{children:c[0].toFixed?c[0].toFixed(6):c[0]})]}),e.jsxs("span",{children:["Lng: ",e.jsx("strong",{children:c[1].toFixed?c[1].toFixed(6):c[1]})]})]}),!c&&e.jsx("p",{className:"location-hint",children:'Click on the map or use "My Location" to set the parking spot location'})]})}const A=["Open","Covered","Garage","Street","Underground"],oe=W,le=["booking.requested","payment.completed","booking.cancelled","booking.checkin","booking.checkout"];function pe(){const[m,p]=n.useState([]),[x,c]=n.useState(!0),[N,w]=n.useState(!1),[u,y]=n.useState(null),[f,C]=n.useState(null),[F,S]=n.useState(""),[P,I]=n.useState([]),{subscribeToRefresh:j}=G(),g={title:"",description:"",address:"",city:"",state:"",country:"India",postalCode:"",latitude:"",longitude:"",parkingType:0,totalSpots:10,hourlyRate:50,dailyRate:400,weeklyRate:2500,monthlyRate:8e3,is24Hours:!0,amenities:"",specialInstructions:""},[a,o]=n.useState(g),v=n.useCallback(async(t=!0)=>{try{const s=await b.getMyListings();s.success&&s.data&&p(s.data)}catch(s){i.error(T(s,"Failed to load listings"))}t&&c(!1)},[]),L=n.useCallback(async()=>{try{const t=await b.getVendorBookings();t.success&&t.data?.bookings&&I(t.data.bookings)}catch(t){console.error("Fetch bookings error:",t)}},[]);n.useEffect(()=>{(async()=>(c(!0),await Promise.all([v(!1),L()]),c(!1)))()},[v,L]),n.useEffect(()=>j("VendorListings",le,()=>{console.log("üîÑ VendorListings: Auto-refreshing due to notification"),v(!1),L()}),[j,v,L]);const M=t=>{const s=new Date,r=[0,1,2,6,"Pending","Confirmed","InProgress","AwaitingPayment"];return P.filter(l=>l.parkingSpaceId===t&&r.includes(l.status)&&new Date(l.endDateTime)>s).sort((l,d)=>new Date(l.startDateTime)-new Date(d.startDateTime))},B=t=>({0:"Pending",1:"Confirmed",2:"InProgress",6:"AwaitingPayment"})[t]||t,$=t=>{const s=t===1||t==="Confirmed",r=t===2||t==="InProgress";return{background:s?"rgba(16,185,129,0.2)":r?"rgba(234,179,8,0.2)":"rgba(107,114,128,0.2)",color:s?"#10b981":r?"#eab308":"#9ca3af"}},D=t=>{const s=new Date(t);return s.toLocaleDateString("en-IN",{day:"numeric",month:"short"})+" "+s.toLocaleTimeString("en-IN",{hour:"2-digit",minute:"2-digit"})},z=async t=>{t.preventDefault();const s={...a,latitude:parseFloat(a.latitude)||0,longitude:parseFloat(a.longitude)||0,totalSpots:parseInt(a.totalSpots),hourlyRate:parseFloat(a.hourlyRate),dailyRate:parseFloat(a.dailyRate),weeklyRate:parseFloat(a.weeklyRate),monthlyRate:parseFloat(a.monthlyRate),parkingType:parseInt(a.parkingType),amenities:a.amenities?a.amenities.split(",").map(r=>r.trim()):[]};try{let r;u?r=await b.updateParking(u,s):r=await b.createParking(s),r.success?(i.success(u?"Listing updated successfully!":"Listing created successfully!"),w(!1),y(null),o(g),v()):i.error(r.message||"Operation failed")}catch(r){i.error(T(r,"Failed to save listing"))}},q=t=>{o({...t,amenities:t.amenities?.join(", ")||""}),y(t.id),w(!0)},H=async t=>{if(window.confirm("Are you sure you want to delete this listing?"))try{const s=await b.deleteParking(t);s.success?(i.success("Listing deleted successfully!"),v()):i.error(s.message||"Delete failed")}catch(s){i.error(T(s,"Failed to delete listing"))}},U=async(t,s)=>{if(!s||s.length===0)return;C(t),S("Starting upload...");const r=[],l=[];try{for(let d=0;d<s.length;d++){const h=s[d];S(`Uploading ${d+1}/${s.length}...`);try{const k=await b.getPresignedUrl(t,h.name,h.type);if(!k.success)throw new Error("Failed to get upload URL");const{uploadUrl:R,publicUrl:O}=k.data;if(!(await fetch(R,{method:"PUT",headers:{"Content-Type":h.type},body:h})).ok)throw new Error("Failed to upload to storage");r.push(O)}catch(k){console.error(`Upload error for ${h.name}:`,k),l.push(h.name)}}r.length>0?(S("Finalizing..."),(await b.confirmUpload(t,r)).success?(i.success(`${r.length} file(s) uploaded successfully!`),l.length>0&&i.error(`Failed to upload: ${l.join(", ")}`),v()):i.error("Failed to confirm uploads")):l.length>0&&i.error("All uploads failed")}catch(d){console.error("Upload process error:",d),i.error(T(d,"Upload process failed"))}C(null),S("")},V=async(t,s)=>{if(!window.confirm("Delete this image?"))return;const r=s.split("/").pop();try{const l=await b.deleteParkingFile(t,r);l.success?(i.success("File deleted"),v()):i.error(l.message||"Delete failed")}catch(l){i.error(T(l,"Failed to delete file"))}},_=async()=>{if(a.postalCode&&a.postalCode.length<6){i.error("Postal code must be 6 digits");return}if(a.postalCode.length===6)try{const s=await(await fetch(`https://api.postalpincode.in/pincode/${a.postalCode}`)).json();if(s&&s[0]&&s[0].Status==="Success"){const r=s[0].PostOffice[0],l=r.State,d=r.District;if(l!==a.state){i.error(`Postal code belongs to ${l}, not ${a.state}`),o(R=>({...R,postalCode:""}));return}const h=a.city.toLowerCase(),k=d.toLowerCase();if(!k.includes(h)&&!h.includes(k)){i.error(`Postal code belongs to ${d}, not ${a.city}`),o(R=>({...R,postalCode:""}));return}i.success("Postal code verified")}else i.error("Invalid Postal Code"),o(r=>({...r,postalCode:""}))}catch(t){console.error("PIN verification failed:",t)}};return e.jsx("div",{className:"page",children:e.jsxs("div",{className:"container",children:[e.jsxs("div",{className:"flex-between mb-3",children:[e.jsx("h1",{children:"My Parking Listings"}),e.jsx("button",{className:"btn btn-primary",onClick:()=>{o(g),y(null),w(!N)},children:N?"Cancel":"+ Add Listing"})]}),N&&e.jsxs("div",{className:"card mb-3",children:[e.jsx("h3",{className:"card-title mb-2",children:u?"Edit Listing":"Create New Listing"}),e.jsxs("form",{onSubmit:z,children:[e.jsxs("div",{className:"grid grid-2",style:{gap:"1rem"},children:[e.jsxs("div",{className:"form-group",style:{margin:0},children:[e.jsx("label",{className:"form-label",children:"Title *"}),e.jsx("input",{type:"text",className:"form-input",value:a.title,onChange:t=>o({...a,title:t.target.value}),required:!0})]}),e.jsxs("div",{className:"form-group",style:{margin:0},children:[e.jsx("label",{className:"form-label",children:"Parking Type"}),e.jsx("select",{className:"form-select",value:a.parkingType,onChange:t=>o({...a,parkingType:t.target.value}),children:A.map((t,s)=>e.jsx("option",{value:s,children:t},s))})]})]}),e.jsxs("div",{className:"form-group mt-1",children:[e.jsx("label",{className:"form-label",children:"Description"}),e.jsx("textarea",{className:"form-input",rows:"3",value:a.description,onChange:t=>o({...a,description:t.target.value})})]}),e.jsxs("div",{className:"grid grid-4",style:{gap:"1rem"},children:[e.jsxs("div",{className:"form-group",style:{margin:0},children:[e.jsx("label",{className:"form-label",children:"Address *"}),e.jsx("input",{type:"text",className:"form-input",value:a.address,onChange:t=>o({...a,address:t.target.value}),required:!0})]}),e.jsxs("div",{className:"form-group",style:{margin:0},children:[e.jsx("label",{className:"form-label",style:{display:"block",marginBottom:"0.5rem"},children:"State *"}),e.jsxs("select",{className:"form-select",style:{width:"100%"},value:a.state,onChange:t=>{const s=t.target.value;o({...a,state:s,city:""})},required:!0,children:[e.jsx("option",{value:"",children:"Select State"}),K.map(t=>e.jsx("option",{value:t,children:t},t))]})]}),e.jsxs("div",{className:"form-group",style:{margin:0},children:[e.jsx("label",{className:"form-label",style:{display:"block",marginBottom:"0.5rem"},children:"City *"}),e.jsxs("select",{className:"form-select",style:{width:"100%"},value:a.city,onChange:t=>o({...a,city:t.target.value}),required:!0,disabled:!a.state,children:[e.jsx("option",{value:"",children:"Select City"}),a.state&&Z[a.state]?.map(t=>e.jsx("option",{value:t,children:t},t))]})]}),e.jsxs("div",{className:"form-group",style:{margin:0},children:[e.jsx("label",{className:"form-label",style:{display:"block",marginBottom:"0.5rem"},children:"Postal Code *"}),e.jsx("input",{type:"text",className:"form-input",style:{width:"100%"},value:a.postalCode,onChange:t=>{const s=t.target.value;/^\d{0,6}$/.test(s)&&o({...a,postalCode:s})},onBlur:_,required:!0,placeholder:"6 digits"})]})]}),e.jsx(re,{latitude:a.latitude,longitude:a.longitude,onLocationSelect:(t,s)=>o(r=>({...r,latitude:t,longitude:s}))}),e.jsxs("div",{className:"grid grid-4 mt-1",style:{gap:"1rem"},children:[e.jsxs("div",{className:"form-group",style:{margin:0},children:[e.jsx("label",{className:"form-label",children:"Total Spots *"}),e.jsx("input",{type:"number",className:"form-input",value:a.totalSpots,onChange:t=>o({...a,totalSpots:t.target.value}),required:!0,min:"1"})]}),e.jsxs("div",{className:"form-group",style:{margin:0},children:[e.jsx("label",{className:"form-label",children:"Hourly Rate (‚Çπ) *"}),e.jsx("input",{type:"number",className:"form-input",value:a.hourlyRate,onChange:t=>o({...a,hourlyRate:t.target.value}),required:!0})]}),e.jsxs("div",{className:"form-group",style:{margin:0},children:[e.jsx("label",{className:"form-label",children:"Daily Rate (‚Çπ) *"}),e.jsx("input",{type:"number",className:"form-input",value:a.dailyRate,onChange:t=>o({...a,dailyRate:t.target.value}),required:!0})]}),e.jsxs("div",{className:"form-group",style:{margin:0},children:[e.jsx("label",{className:"form-label",children:"Monthly Rate (‚Çπ) *"}),e.jsx("input",{type:"number",className:"form-input",value:a.monthlyRate,onChange:t=>o({...a,monthlyRate:t.target.value}),required:!0})]})]}),e.jsxs("div",{className:"form-group mt-1",children:[e.jsx("label",{className:"form-label",children:"Amenities (comma-separated)"}),e.jsx("input",{type:"text",className:"form-input",placeholder:"CCTV, Security, Covered, EV Charging",value:a.amenities,onChange:t=>o({...a,amenities:t.target.value})})]}),e.jsx("div",{className:"form-group",children:e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer"},children:[e.jsx("input",{type:"checkbox",checked:a.is24Hours,onChange:t=>o({...a,is24Hours:t.target.checked})}),"24/7 Available"]})}),e.jsx("button",{type:"submit",className:"btn btn-primary",children:u?"Update Listing":"Create Listing"})]})]}),x?e.jsx("div",{className:"loading",children:e.jsx("div",{className:"spinner"})}):m.length===0?e.jsxs("div",{className:"empty-state",children:[e.jsx("div",{className:"empty-icon",children:"üÖøÔ∏è"}),e.jsx("h3",{children:"No listings yet"}),e.jsx("p",{children:"Create your first parking listing to start earning"})]}):e.jsx("div",{className:"grid grid-2",children:m.map(t=>e.jsxs("div",{className:"card hover-card",children:[e.jsxs("div",{className:"flex-between",children:[e.jsx("h3",{className:"card-title",children:t.title}),e.jsx("span",{className:`parking-tag ${t.isActive?"":"inactive"}`,style:{background:t.isActive?"rgba(16, 185, 129, 0.2)":"rgba(107, 114, 128, 0.2)"},children:t.isActive?"Active":"Inactive"})]}),e.jsxs("div",{className:"parking-location",children:["üìç ",t.address,", ",t.city]}),e.jsxs("div",{className:"flex gap-2 mt-1",children:[e.jsx("span",{className:"parking-tag",children:A[t.parkingType]}),e.jsxs("span",{className:"parking-tag",children:[t.totalSpots," spots"]}),e.jsxs("span",{className:"rating",children:["‚≠ê ",t.averageRating?.toFixed(1)||"New"]})]}),e.jsxs("div",{className:"parking-price mt-1",children:["‚Çπ",t.hourlyRate,e.jsx("span",{children:"/hr"})]}),(()=>{const s=M(t.id);return s.length===0?null:e.jsxs("div",{style:{marginTop:"1rem",padding:"0.75rem",background:"rgba(59, 130, 246, 0.1)",borderRadius:"var(--radius-sm)",border:"1px solid rgba(59, 130, 246, 0.3)"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.5rem",marginBottom:"0.5rem"},children:[e.jsx("span",{style:{fontSize:"0.9rem"},children:"üìÖ"}),e.jsxs("strong",{style:{color:"var(--color-primary)",fontSize:"0.85rem"},children:["Active Reservations (",s.length,")"]})]}),e.jsxs("div",{style:{maxHeight:"180px",overflowY:"auto"},children:[s.slice(0,5).map(r=>e.jsxs("div",{style:{padding:"0.5rem",marginBottom:"0.4rem",background:"rgba(0,0,0,0.2)",borderRadius:"6px",fontSize:"0.8rem"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"0.3rem"},children:[e.jsx("span",{style:{padding:"2px 6px",borderRadius:"4px",fontSize:"0.7rem",...$(r.status)},children:B(r.status)}),e.jsxs("span",{style:{color:"var(--color-text-muted)",fontSize:"0.75rem"},children:[D(r.startDateTime)," ‚Üí ",D(r.endDateTime)]})]}),e.jsxs("div",{style:{display:"flex",gap:"0.75rem",marginTop:"0.3rem"},children:[e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx("span",{style:{fontSize:"0.85rem"},children:"üë§"}),e.jsx("span",{style:{fontWeight:"500"},children:r.userName||"Unknown"})]}),r.vehicleNumber&&e.jsxs("div",{style:{display:"flex",alignItems:"center",gap:"0.25rem"},children:[e.jsx("span",{style:{fontSize:"0.85rem"},children:"üöó"}),e.jsx("span",{children:r.vehicleNumber}),r.vehicleModel&&e.jsxs("span",{style:{color:"var(--color-text-muted)"},children:["(",r.vehicleModel,")"]})]})]})]},r.id)),s.length>5&&e.jsxs("div",{style:{fontSize:"0.75rem",color:"var(--color-text-muted)",paddingTop:"0.3rem"},children:["+",s.length-5," more..."]})]})]})})(),t.imageUrls&&t.imageUrls.length>0&&e.jsxs("div",{style:{marginTop:"1rem"},children:[e.jsxs("small",{style:{color:"var(--color-text-muted)"},children:["Images (",t.imageUrls.length,")"]}),e.jsx("div",{style:{display:"flex",gap:"0.5rem",flexWrap:"wrap",marginTop:"0.5rem"},children:t.imageUrls.map((s,r)=>e.jsxs("div",{style:{position:"relative"},children:[e.jsx("img",{src:s.startsWith("http")?s:`${oe}${s}`,alt:`Parking ${r+1}`,style:{width:"60px",height:"60px",objectFit:"cover",borderRadius:"var(--radius-sm)",cursor:"pointer"},loading:"lazy"}),e.jsx("button",{onClick:l=>{l.stopPropagation(),V(t.id,s)},style:{position:"absolute",top:"-6px",right:"-6px",width:"18px",height:"18px",borderRadius:"50%",background:"#ef4444",color:"white",border:"none",cursor:"pointer",fontSize:"12px",display:"flex",alignItems:"center",justifyContent:"center"},children:"√ó"})]},r))})]}),e.jsxs("div",{style:{marginTop:"1rem"},children:[e.jsxs("label",{style:{display:"block",padding:"0.75rem",border:"2px dashed var(--color-border)",borderRadius:"var(--radius-sm)",textAlign:"center",cursor:f===t.id?"wait":"pointer",transition:"border-color 0.2s",background:"rgba(99, 102, 241, 0.05)"},onDragOver:s=>{s.preventDefault(),s.currentTarget.style.borderColor="var(--color-primary)"},onDragLeave:s=>{s.currentTarget.style.borderColor="var(--color-border)"},onDrop:s=>{s.preventDefault(),s.currentTarget.style.borderColor="var(--color-border)",U(t.id,s.dataTransfer.files)},children:[e.jsx("input",{type:"file",multiple:!0,accept:"image/jpeg,image/png,image/webp,video/mp4,video/webm",style:{display:"none"},onChange:s=>U(t.id,s.target.files),disabled:f===t.id}),f===t.id?e.jsxs("span",{children:["‚è≥ ",F]}):e.jsx("span",{style:{color:"var(--color-text-muted)",fontSize:"0.85rem"},children:"üì∑ Drop images/videos or click to upload"})]}),e.jsx("small",{style:{color:"var(--color-text-muted)",display:"block",marginTop:"0.25rem"},children:"Max: 5MB images, 50MB videos"})]}),e.jsxs("div",{className:"flex gap-1 mt-2",children:[e.jsx("button",{className:"btn btn-secondary",onClick:()=>q(t),children:"Edit"}),e.jsx("button",{className:"btn btn-danger",onClick:()=>H(t.id),children:"Delete"}),e.jsx(Y,{to:`/parking/${t.id}`,className:"btn btn-outline",children:"View"})]})]},t.id))})]})})}export{pe as default};
